name: Release a new version

on:
  release:
    types:
      - published

jobs:
  update-flightctl-dependency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: celdrake/flightctl
          ref: main
          path: ../flightctl

      - name: Update the helm dependency in flightctl
        working-directory: ../flightctl
        run: |
          git checkout -b update-ui-to-last-release
          cd deploy/helm/flightctl
          HELM_VERSION=$(helm version)
          PWD=$(pwd)
          echo "Helm version=${HELM_VERSION} in ${PWD}" >> "$GITHUB_OUTPUT"
          echo "Helm version=${HELM_VERSION} in ${PWD}"
          helm dependency list --debug

      - name: Create the PR in flightctl repository
        if: ${{ github.event.release.target_commitish == 'skip-this' }}
        uses: peter-evans/create-pull-request@v7
        with:
          base: master
          commit-message: Test Update UI to Version ${{ github.ref_name }}
          committer: GitHub action executed on release <noreply@github.com>
          author: GitHub action executed on release <noreply@github.com>
          title: Test Update UI to Version ${{ github.ref_name }}
          body:
            Triggered by new UI tag - https://github.com/flightctl/flightctl-ui/releases/tag/v$${{ github.ref_name }}
